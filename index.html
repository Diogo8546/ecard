<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>e-Card</title>
    
    <!-- Tags para comportamento de Web App (PWA) -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="USP e-Card">
    <meta name="application-name" content="USP e-Card">
    <meta name="theme-color" content="#FADDAF">
    
    <!-- Link para o Manifesto (essencial para Android) -->
    <link rel="manifest" href="manifest.json">

    <!-- Ícone do App na tela inicial do iPhone -->
    <link rel="apple-touch-icon" href="ecard.png">

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Libraries for QR Code and Barcode generation -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        /* Custom font and colors */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        html, body {
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #FADDAF; 
        }
        .card-bg {
            background-color: #FADDAF;
        }
        .profile-pic {
            width: 120px;
            height: 150px;
            object-fit: cover;
        }
        .main-text {
            color: #000000;
        }
        /* Cor dos ícones no cabeçalho */
        header {
             color: #000000;
        }
        /* Ajuste para altura do container do código */
        .code-container {
            min-height: 210px; 
        }
    </style>
</head>
<body class="card-bg">

    <!-- Main Card Component -->
    <div class="flex flex-col h-screen main-text">
        <!-- Header -->
        <header class="relative flex justify-center items-center p-4">
            <!-- Icons on the left -->
            <div class="absolute left-4 flex items-center space-x-4">
                <button id="login-button" class="text-2xl">
                    <i class="fa-solid fa-user-circle"></i>
                </button>
                <button id="edit-button" class="text-2xl">
                    <i class="fa-solid fa-id-card"></i>
                </button>
            </div>
            <!-- Title centered and in white -->
            <h1 class="text-xl font-medium text-white">e-Card</h1>
            <!-- Icon on the right -->
            <div class="absolute right-4 flex items-center">
                <button id="toggle-button" class="text-2xl">
                     <i class="fa-solid fa-barcode"></i>
                </button>
            </div>
        </header>

        <!-- Card Body -->
        <main class="flex-grow flex flex-col items-center justify-center text-center px-4 pb-4">
            <!-- Unified Content Container -->
            <div class="w-full flex flex-col items-center">
                <!-- USP Logo -->
                <img id="logo-display" src="usplogo.png" alt="Logo da USP" class="h-16" onerror="this.onerror=null;this.src='https://placehold.co/200x80/FADDAF/333333?text=usplogo.png';">
                <p class="text-sm font-medium">Universidade de São Paulo</p>

                <p class="font-bold my-2 tracking-widest">ALUNO</p>

                <!-- Profile Picture -->
                <img id="profile-pic-display" src="https://placehold.co/120x150/cccccc/333333?text=Foto" alt="Foto do Aluno" class="profile-pic rounded-lg shadow-md">

                <!-- Student Info -->
                <div class="mt-3">
                    <h2 id="name-display" class="text-2xl font-bold">Diogo Dias Furtado</h2>
                    <p id="number-display" class="text-xl">12690601</p>
                    <p class="mt-2 text-lg font-bold">Faculdade de Filosofia, Ciências e Letras de Rib Preto</p>
                </div>
                
                <!-- Bottom Section (Code) -->
                <div class="w-full mt-4">
                    <!-- QR Code / Barcode Container -->
                    <div class="w-full max-w-[200px] mx-auto cursor-pointer code-container flex justify-center items-center">
                         <div id="qrcode-container" class="p-3 bg-white rounded-lg shadow-inner flex justify-center items-center"></div>
                         <div id="barcode-container" class="hidden w-full bg-white p-3 rounded-lg shadow-inner flex items-center justify-center">
                            <svg id="barcode"></svg>
                         </div>
                    </div>

                    <!-- Expiration Text -->
                    <div id="footer-container" class="pt-1">
                        <p id="expiration-text" class="text-center text-xs">
                             <!-- O texto será definido via JS -->
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for Editing Information -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="relative p-6 bg-white rounded-lg shadow-md w-full max-w-md">
            <button id="close-modal-button" class="absolute top-2 right-3 text-gray-500 hover:text-gray-800 text-3xl font-light">&times;</button>
            <h3 class="text-lg font-bold mb-4 text-center">Editar Informações</h3>
            <div class="space-y-4">
                <div>
                    <label for="name-input" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                    <input type="text" id="name-input" value="Diogo Dias Furtado" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="number-input" class="block text-sm font-medium text-gray-700">Número USP</label>
                    <input type="text" id="number-input" value="12690601" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                     <label for="photo-input" class="block text-sm font-medium text-gray-700">Foto de Perfil</label>
                     <input type="file" id="photo-input" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                <div>
                     <label for="logo-input" class="block text-sm font-medium text-gray-700">Logo</label>
                     <input type="file" id="logo-input" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Zooming Code -->
    <div id="zoom-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 cursor-pointer">
        <div id="zoom-content" class="bg-white p-4 rounded-lg">
            <!-- Larger QR/Barcode will be generated here -->
        </div>
    </div>


    <script>
        // DOM Elements
        const toggleButton = document.getElementById('toggle-button');
        const qrContainer = document.getElementById('qrcode-container');
        const barcodeContainer = document.getElementById('barcode-container');
        const footerContainer = document.getElementById('footer-container');
        const expirationText = document.getElementById('expiration-text');
        const nameDisplay = document.getElementById('name-display');
        const numberDisplay = document.getElementById('number-display');
        const profilePicDisplay = document.getElementById('profile-pic-display');
        const logoDisplay = document.getElementById('logo-display');

        const nameInput = document.getElementById('name-input');
        const numberInput = document.getElementById('number-input');
        const photoInput = document.getElementById('photo-input');
        const logoInput = document.getElementById('logo-input');

        // Modal elements
        const editButton = document.getElementById('edit-button');
        const editModal = document.getElementById('edit-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const zoomModal = document.getElementById('zoom-modal');
        const zoomContent = document.getElementById('zoom-content');
        // const loginButton = document.getElementById('login-button'); // Ready for future functionality

        let isQrVisible = true;

        // --- Data Persistence Logic ---
        const saveData = () => {
            localStorage.setItem('ecard-name', nameInput.value);
            localStorage.setItem('ecard-number', numberInput.value);
            // Images are saved as Base64 strings
            localStorage.setItem('ecard-photo', profilePicDisplay.src);
            localStorage.setItem('ecard-logo', logoDisplay.src);
        };

        const loadData = () => {
            const savedName = localStorage.getItem('ecard-name');
            const savedNumber = localStorage.getItem('ecard-number');
            const savedPhoto = localStorage.getItem('ecard-photo');
            const savedLogo = localStorage.getItem('ecard-logo');

            if (savedName) {
                nameDisplay.textContent = savedName;
                nameInput.value = savedName;
            }
            if (savedNumber) {
                numberDisplay.textContent = savedNumber;
                numberInput.value = savedNumber;
            }
            if (savedPhoto) {
                profilePicDisplay.src = savedPhoto;
            }
            if (savedLogo) {
                logoDisplay.src = savedLogo;
            }
        };

        // Function to set expiration date (dynamically)
        const setExpirationText = () => {
            const today = new Date();
            const expirationDate = new Date(today);
            
            // A data de validade agora reflete a data atual, sem adicionar um ano.
            expirationDate.setHours(23, 59, 0, 0);

            const day = String(expirationDate.getDate()).padStart(2, '0');
            const month = String(expirationDate.getMonth() + 1).padStart(2, '0');
            const year = expirationDate.getFullYear();
            const hours = String(expirationDate.getHours()).padStart(2, '0');
            const minutes = String(expirationDate.getMinutes()).padStart(2, '0');
            expirationText.textContent = `Expira em ${day}/${month}/${year} ${hours}:${minutes}`;
        };

        // Function to generate codes
        const generateCodes = (value) => {
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: value, width: 200, height: 200, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H
            });
            try {
                 JsBarcode("#barcode", value, {
                    format: "CODE128", lineColor: "#000", width: 2.5, height: 100, displayValue: false
                });
            } catch (e) {
                console.error("Error generating barcode:", e);
                barcodeContainer.innerHTML = '<p class="text-red-500 text-xs">Valor inválido</p>';
            }
        };

        // Toggle visibility between QR and Barcode
        toggleButton.addEventListener('click', () => {
            isQrVisible = !isQrVisible;
            qrContainer.classList.toggle('hidden');
            barcodeContainer.classList.toggle('hidden');
            footerContainer.classList.toggle('hidden');
            toggleButton.innerHTML = isQrVisible ? '<i class="fa-solid fa-barcode"></i>' : '<i class="fa-solid fa-qrcode"></i>';
        });

        // --- Update Logic ---
        nameInput.addEventListener('input', () => { 
            nameDisplay.textContent = nameInput.value || 'Seu Nome Aqui'; 
            saveData();
        });
        numberInput.addEventListener('input', () => {
            const studentNumber = numberInput.value || '00000000';
            numberDisplay.textContent = studentNumber;
            generateCodes(studentNumber);
            saveData();
        });
        const handleFileSelect = (event, displayElement) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { 
                    displayElement.src = e.target.result; 
                    saveData();
                };
                reader.readAsDataURL(file);
            }
        };
        photoInput.addEventListener('change', (e) => handleFileSelect(e, profilePicDisplay));
        logoInput.addEventListener('change', (e) => handleFileSelect(e, logoDisplay));
        
        // --- Modal Logic ---
        editButton.addEventListener('click', () => { editModal.classList.remove('hidden'); });
        closeModalButton.addEventListener('click', () => { editModal.classList.add('hidden'); });
        editModal.addEventListener('click', (event) => {
            if (event.target === editModal) editModal.classList.add('hidden');
        });

        // --- Zoom Logic ---
        qrContainer.addEventListener('click', () => {
            zoomContent.innerHTML = '';
            new QRCode(zoomContent, {
                text: numberInput.value || '00000000', width: 280, height: 280, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H
            });
            zoomModal.classList.remove('hidden');
        });
        barcodeContainer.addEventListener('click', () => {
            zoomContent.innerHTML = '';
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.id = 'zoomed-barcode';
            zoomContent.appendChild(svg);
            try {
                JsBarcode("#zoomed-barcode", numberInput.value || '00000000', {
                    format: "CODE128", lineColor: "#000", width: 3, height: 120, displayValue: false
                });
            } catch (e) {
                 zoomContent.innerHTML = '<p class="text-red-500 text-xs">Valor inválido</p>';
            }
            zoomModal.classList.remove('hidden');
        });
        zoomModal.addEventListener('click', () => {
            zoomModal.classList.add('hidden');
            zoomContent.innerHTML = '';
        });

        // Initial generation on page load
        window.onload = () => {
            loadData();
            generateCodes(numberInput.value);
            setExpirationText();
            if (!isQrVisible) footerContainer.classList.add('hidden');
        };
    </script>
</body>
</html>


